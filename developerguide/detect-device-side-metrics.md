# Device\-side metrics<a name="detect-device-side-metrics"></a>

When creating a Security Profile, you can specify your IoT device's expected behavior by configuring behaviors and thresholds for metrics generated by IoT devices\. The following are device\-side metrics, which are metrics from agents that you install on your devices\.

## Bytes out \(`aws:all-bytes-out`\)<a name="detect-all-bytes-out"></a>

The number of outbound bytes from a device during a given time period\.

Use this metric to specify the maximum or minimum amount of outbound traffic that a device should send, measured in bytes, in a given period of time\.

Compatible with: Rules Detect \| ML Detect

Operators: less\-than \| less\-than\-equals \| greater\-than \| greater\-than\-equals 

Value: a non\-negative integer 

Units: bytes 

Duration: a non\-negative integer\. Valid values are 300, 600, 900, 1800, or 3600 seconds\.

**Example**  

```
{
  "name": "TCP outbound traffic",
  "metric": "aws:all-bytes-out",
  "criteria": {
    "comparisonOperator": "less-than-equals",
    "value": {
      "count": 4096
    },
    "durationSeconds": 300,
    "consecutiveDatapointsToAlarm": 1,
    "consecutiveDatapointsToClear": 1
  },
  "suppressAlerts": true
}
```

**Example using a `statisticalThreshold`**  

```
{
  "name": "TCP outbound traffic",
  "metric": "aws:all-bytes-out",
  "criteria": {
    "comparisonOperator": "less-than-equals",
    "statisticalThreshold": {
      "statistic": "p50"
    },
    "durationSeconds": 900,
    "consecutiveDatapointsToAlarm": 1,
    "consecutiveDatapointsToClear": 1
  },
  "suppressAlerts": true
}
```

**Example using ML Detect**  

```
{
  "name": "Outbound traffic ML behavior",
  "metric": "aws:all-bytes-out",
  "criteria": {
    "consecutiveDatapointsToAlarm": 1,
    "consecutiveDatapointsToClear": 1,
    "mlDetectionConfig": {
      "confidenceLevel": "HIGH"
    }
  },
  "suppressAlerts": true
}
```

## Bytes in \(`aws:all-bytes-in`\)<a name="detect-all-bytes-in"></a>

The number of inbound bytes to a device during a given time period\.

Use this metric to specify the maximum or minimum amount of inbound traffic that a device should receive, measured in bytes, in a given period of time\.

Compatible with: Rules Detect \| ML Detect

Operators: less\-than \| less\-than\-equals \| greater\-than \| greater\-than\-equals 

Value: a non\-negative integer 

Units: bytes 

Duration: a non\-negative integer\. Valid values are 300, 600, 900, 1800, or 3600 seconds\.

**Example**  

```
{
  "name": "TCP inbound traffic",
  "metric": "aws:all-bytes-in",
  "criteria": {
    "comparisonOperator": "less-than-equals",
    "value": {
      "count": 4096
    },
    "durationSeconds": 300,
    "consecutiveDatapointsToAlarm": 1,
    "consecutiveDatapointsToClear": 1
  },
  "suppressAlerts": true
}
```

**Example using a `statisticalThreshold`**  

```
{
  "name": "TCP inbound traffic",
  "metric": "aws:all-bytes-in",
  "criteria": {
    "comparisonOperator": "less-than-equals",
    "statisticalThreshold": {
      "statistic": "p90"
    },
    "durationSeconds": 300,
    "consecutiveDatapointsToAlarm": 1,
    "consecutiveDatapointsToClear": 1
  },
  "suppressAlerts": true
}
```

**Example using ML Detect**  

```
{
  "name": "Inbound traffic ML behavior",
  "metric": "aws:all-bytes-in",
  "criteria": {
    "consecutiveDatapointsToAlarm": 1,
    "consecutiveDatapointsToClear": 1,
    "mlDetectionConfig": {
      "confidenceLevel": "HIGH"
    }
  },
  "suppressAlerts": true
}
```

## Listening TCP port count \(`aws:num-listening-tcp-ports`\)<a name="detect-num-listening-tcp-ports"></a>

The number of TCP ports the device is listening on\.

Use this metric to specify the maximum number of TCP ports that each device should monitor\.

Compatible with: Rules Detect \| ML Detect

Unit: failures 

Operators: less\-than \| less\-than\-equals \| greater\-than \| greater\-than\-equals 

Value: a non\-negative integer 

Units: failures 

Duration: a non\-negative integer\. Valid values are 300, 600, 900, 1800, or 3600 seconds\.

**Example**  

```
{
  "name": "Max TCP Ports",
  "metric": "aws:num-listening-tcp-ports",
  "criteria": {
    "comparisonOperator": "less-than-equals",
    "value": {
      "count": 5
    },
    "durationSeconds": 300,
    "consecutiveDatapointsToAlarm": 1,
    "consecutiveDatapointsToClear": 1
  },
  "suppressAlerts": true
}
```

**Example using a `statisticalThreshold`**  

```
{
  "name": "Max TCP Ports",
  "metric": "aws:num-listening-tcp-ports",
  "criteria": {
    "comparisonOperator": "less-than-equals",
    "statisticalThreshold": {
      "statistic": "p50"
    },
    "durationSeconds": 300,
    "consecutiveDatapointsToAlarm": 1,
    "consecutiveDatapointsToClear": 1
  },
  "suppressAlerts": true
}
```

**Example using ML detect**  

```
{
  "name": "Max TCP Port ML behavior",
  "metric": "aws:num-listening-tcp-ports",
  "criteria": {
    "consecutiveDatapointsToAlarm": 1,
    "consecutiveDatapointsToClear": 1,
    "mlDetectionConfig": {
      "confidenceLevel": "HIGH"
    }
  },
  "suppressAlerts": true
}
```

## Listening UDP port count \(`aws:num-listening-udp-ports`\)<a name="detect-num-listening-udp-ports"></a>

The number of UDP ports the device is listening on\.

Use this metric to specify the maximum number of UDP ports that each device should monitor\.

Compatible with: Rules Detect \| ML Detect

Unit: failures 

Operators: less\-than \| less\-than\-equals \| greater\-than \| greater\-than\-equals 

Value: a non\-negative integer 

Units: failures 

Duration: a non\-negative integer\. Valid values are 300, 600, 900, 1800, or 3600 seconds\.

**Example**  

```
{
  "name": "Max UDP Ports",
  "metric": "aws:num-listening-udp-ports",
  "criteria": {
    "comparisonOperator": "less-than-equals",
    "value": {
      "count": 5
    },
    "durationSeconds": 300,
    "consecutiveDatapointsToAlarm": 1,
    "consecutiveDatapointsToClear": 1
  },
  "suppressAlerts": true
}
```

**Example using a `statisticalThreshold`**  

```
{
  "name": "Max UDP Ports",
  "metric": "aws:num-listening-udp-ports",
  "criteria": {
    "comparisonOperator": "less-than-equals",
    "statisticalThreshold": {
      "statistic": "p50"
    },
    "durationSeconds": 300,
    "consecutiveDatapointsToAlarm": 1,
    "consecutiveDatapointsToClear": 1
  },
  "suppressAlerts": true
}
```

**Example using ML Detect**  

```
{
  "name": "Max UPD Port ML behavior",
  "metric": "aws:num-listening-tcp-ports",
  "criteria": {
	 "consecutiveDatapointsToAlarm": 1,
	 "consecutiveDatapointsToClear": 1,
	 "mlDetectionConfig": {
	   "confidenceLevel": "HIGH"
   }
	},
  "suppressAlerts": true
}
```

## Packets out \(`aws:all-packets-out`\)<a name="detect-all-packets-out"></a>

The number of outbound packets from a device during a given time period\.

Use this metric to specify the maximum or minimum amount of total outbound traffic that a device should send in a given period of time\.

Compatible with: Rules Detect \| ML Detect

Operators: less\-than \| less\-than\-equals \| greater\-than \| greater\-than\-equals 

Value: a non\-negative integer 

Units: packets 

Duration: a non\-negative integer\. Valid values are 300, 600, 900, 1800, or 3600 seconds\.

**Example**  

```
{
  "name": "TCP outbound traffic",
  "metric": "aws:all-packets-out",
  "criteria": {
    "comparisonOperator": "less-than-equals",
    "value": {
      "count": 100
    },
    "durationSeconds": 300,
    "consecutiveDatapointsToAlarm": 1,
    "consecutiveDatapointsToClear": 1
  },
  "suppressAlerts": true
}
```

**Example using a `statisticalThreshold`**  

```
{
  "name": "TCP outbound traffic",
  "metric": "aws:all-packets-out",
  "criteria": {
    "comparisonOperator": "less-than-equals",
    "statisticalThreshold": {
      "statistic": "p90"
    },
    "durationSeconds": 300,
    "consecutiveDatapointsToAlarm": 1,
    "consecutiveDatapointsToClear": 1
  },
  "suppressAlerts": true
}
```

**Example using ML Detect**  

```
{
  "name": "Outbound sent ML behavior",
  "metric": "aws:all-packets-out",
  "criteria": {
    "consecutiveDatapointsToAlarm": 1,
    "consecutiveDatapointsToClear": 1,
    "mlDetectionConfig": {
      "confidenceLevel": "HIGH"
    }
  },
  "suppressAlerts": true
}
```

## Packets in \(`aws:all-packets-in`\)<a name="detect-all-packets-in"></a>

The number of inbound packets to a device during a given time period\.

Use this metric to specify the maximum or minimum amount of total inbound traffic that a device should receive in a given period of time\.

Compatible with: Rule Detect \| ML Detect

Operators: less\-than \| less\-than\-equals \| greater\-than \| greater\-than\-equals 

Value: a non\-negative integer 

Units: packets 

Duration: a non\-negative integer\. Valid values are 300, 600, 900, 1800 or 3600 seconds\.

**Example**  

```
{
  "name": "TCP inbound traffic",
  "metric": "aws:all-packets-in",
  "criteria": {
    "comparisonOperator": "less-than-equals",
    "value": {
      "count": 100
    },
    "durationSeconds": 300,
    "consecutiveDatapointsToAlarm": 1,
    "consecutiveDatapointsToClear": 1
  },
  "suppressAlerts": true
}
```

**Example**  
Example using a `statisticalThreshold`  

```
{
  "name": "TCP inbound traffic",
  "metric": "aws:all-packets-in",
  "criteria": {
    "comparisonOperator": "less-than-equals",
    "statisticalThreshold": {
      "statistic": "p90"
    },
    "durationSeconds": 300,
    "consecutiveDatapointsToAlarm": 1,
    "consecutiveDatapointsToClear": 1
  },
  "suppressAlerts": true
}
```

**Example using ML Detect**  

```
{
  "name": "Inbound sent ML behavior",
  "metric": "aws:all-packets-in",
  "criteria": {
    "consecutiveDatapointsToAlarm": 1,
    "consecutiveDatapointsToClear": 1,
    "mlDetectionConfig": {
      "confidenceLevel": "HIGH"
    }
  },
  "suppressAlerts": true
}
```

## Destination IPs \(`aws:destination-ip-addresses`\)<a name="detect-destination-ip-addresses"></a>

A set of IP destinations\.

Use this metric to specify a set of allowed \(formerly referred to as whitelisted\) or denied \(formerly referred to as blacklisted\) Classless Inter\-Domain Routings \(CIDR\) from which each device must or must not connect to AWS IoT\.

Compatible with: Rules Detect

Operators: in\-cidr\-set \| not\-in\-cidr\-set 

Values: a list of CIDRs

Units: n/a

**Example**  

```
{
  "name": "Denied source IPs",
  "metric": "aws:source-ip-address",
  "criteria": {
    "comparisonOperator": "not-in-cidr-set",
    "value": {
      "cidrs": [ "12.8.0.0/16", "15.102.16.0/24" ]
    }
  },
  "suppressAlerts": true
}
```

## Listening TCP ports \(`aws:listening-tcp-ports`\)<a name="detect-listening-tcp-ports"></a>

The TCP ports that the device is listening on\.

Use this metric to specify a set of allowed \(formerly referred to as whitelisted\) or denied \(formerly referred to as blacklisted\) TCP ports on which each device must or must not listen\.

Compatible with: Rules Detect

Operators: in\-port\-set \| not\-in\-port\-set 

Values: a list of ports 

Units: n/a

**Example**  

```
{
  "name": "Listening TCP Ports",
  "metric": "aws:listening-tcp-ports",
  "criteria": {
    "comparisonOperator": "in-port-set",
    "value": {
      "ports": [ 443, 80 ]
    }
  },
  "suppressAlerts": true
}
```

## Listening UDP ports \(`aws:listening-udp-ports`\)<a name="detect-listening-udp-ports"></a>

The UDP ports that the device is listening on\.

Use this metric to specify a set of allowed \(formerly referred to as whitelisted\) or denied \(formerly referred to as blacklisted\) UDP ports on which each device must or must not listen\.

Compatible with: Rules Detect

Operators: in\-port\-set \| not\-in\-port\-set 

Values: a list of ports 

Units: n/a

**Example**  

```
{
  "name": "Listening UDP Ports",
  "metric": "aws:listening-udp-ports",
  "criteria": {
    "comparisonOperator": "in-port-set",
    "value": {
      "ports": [ 1025, 2000 ]
    }
  }
}
```

## Established TCP connections count \(`aws:num-established-tcp-connections`\)<a name="detect-num-established-tcp-connections"></a>

The number of TCP connections for a device\.

Use this metric to specify the maximum or minimum number of active TCP connections that each device should have \(All TCP states\)\. 

Compatible with: Rules Detect \| ML Detect

Operators: less\-than \| less\-than\-equals \| greater\-than \| greater\-than\-equals

Value: a non\-negative integer 

Units: connections

**Example**  

```
{
  "name": "TCP Connection Count",
  "metric": "aws:num-established-tcp-connections",
  "criteria": {
    "comparisonOperator": "less-than-equals",
    "value": {
      "count": 3
    },
    "consecutiveDatapointsToAlarm": 1,
    "consecutiveDatapointsToClear": 1
  },
  "suppressAlerts": true
}
```

**Example using a `statisticalThreshold`**  

```
{
  "name": "TCP Connection Count",
  "metric": "aws:num-established-tcp-connections",
  "criteria": {
    "comparisonOperator": "less-than-equals",
    "statisticalThreshold": {
      "statistic": "p90"
    },
    "durationSeconds": 900,
    "consecutiveDatapointsToAlarm": 1,
    "consecutiveDatapointsToClear": 1
  },
  "suppressAlerts": true
}
```

**Example using ML Detect**  

```
{
  "name": "Connection count ML behavior",
  "metric": "aws:num-established-tcp-connections",
  "criteria": {
    "consecutiveDatapointsToAlarm": 1,
    "consecutiveDatapointsToClear": 1,
    "mlDetectionConfig": {
      "confidenceLevel": "HIGH"
    }
  },
  "suppressAlerts": true
}
```

## Device metrics document specification<a name="DetectMetricsMessagesSpec"></a>


**Overall structure**  

|  Long name  |  Short name  |  Required  |  Type  |  Constraints  |  Notes  | 
| --- | --- | --- | --- | --- | --- | 
|  header  |  hed  |  Y  |  Object  |    |  Complete block required for well\-formed report\.  | 
|  metrics  |  met  |  Y  |  Object  |    |  A report can have both or at least one `metrics` or `custom_metrics` block\.  | 
|  custom\_metrics  |  cmet  |  Y  |  Object  |    |  A report can have both or at least one `metrics` or `custom_metrics` block\.  | 


**Header block**  

|  Long name  |  Short name  |  Required  |  Type  |  Constraints  |  Notes  | 
| --- | --- | --- | --- | --- | --- | 
|  report\_id  |  rid  |  Y  |  Integer  |    |  Monotonically increasing value\. Epoch timestamp recommended\.  | 
|  version  |  v  |  Y  |  String  |  Major\.Minor  |  Minor increments with addition of field\. Major increments if metrics removed\.  | 

**Metrics block:**


**TCP connections**  

|  Long name  |  Short name  |  Parent element  |  Required  |  Type  |  Constraints  |  Notes  | 
| --- | --- | --- | --- | --- | --- | --- | 
|  tcp\_connections  |  tc  |  metrics  |  N  |  Object  |    |    | 
|  established\_connections  |  ec  |  tcp\_connections  |  N  |  Object  |    |  Established TCP state  | 
|  connections  |  cs  |  established\_connections  |  N  |  List<Object>  |    |    | 
|  remote\_addr  |  rad  |  connections  |  Y  |  Number  |  ip:port  |  IP can be IPv6 or IPv4  | 
|  local\_port  |  lp  |  connections  |  N  |  Number  |  >= 0  |    | 
|  local\_interface  |  li  |  connections  |  N  |  String  |    |  Interface name  | 
|  total  |  t  |  established\_connections  |  N  |  Number  |  >= 0  |  Number of established connections  | 


**Listening TCP ports**  

|  Long name  |  Short name  |  Parent element  |  Required  |  Type  |  Constraints  |  Notes  | 
| --- | --- | --- | --- | --- | --- | --- | 
|  listening\_tcp\_ports  |  tp  |  metrics  |  N  |  Object  |    |    | 
|  ports  |  pts  |  listening\_tcp\_ports  |  N  |  List<Object>  |  > 0  |    | 
|  port  |  pt  |  ports  |  N  |  Number  |  > 0  |  ports should be numbers greater than 0  | 
|  interface  |  if  |  ports  |  N  |  String  |    |  Interface name  | 
|  total  |  t  |  listening\_tcp\_ports  |  N  |  Number  |  >= 0  |    | 


**Listening UDP ports**  

|  Long name  |  Short name  |  Parent element  |  Required  |  Type  |  Constraints  |  Notes  | 
| --- | --- | --- | --- | --- | --- | --- | 
|  listening\_udp\_ports  |  up  |  metrics  |  N  |  Object  |    |    | 
|  ports  |  pts  |  listening\_udp\_ports  |  N  |  List<Port>  |  > 0  |    | 
|  port  |  pt  |  ports  |  N  |  Number  |  > 0  |  Ports should be numbers greater than 0  | 
|  interface  |  if  |  ports  |  N  |  String  |    |  Interface name  | 
|  total  |  t  |  listening\_udp\_ports  |  N  |  Number  |  >= 0  |    | 


**Network statistics**  

|  Long name  |  Short name  |  Parent element  |  Required  |  Type  |  Constraints  |  Notes  | 
| --- | --- | --- | --- | --- | --- | --- | 
|  network\_stats  |  ns  |  metrics  |  N  |  Object  |    |    | 
|  bytes\_in  |  bi  |  network\_stats  |  N  |  Number  |  Delta Metric, >= 0  |    | 
|  bytes\_out  |  bo  |  network\_stats  |  N  |  Number  |  Delta Metric, >= 0  |    | 
|  packets\_in  |  pi  |  network\_stats  |  N  |  Number  |  Delta Metric, >= 0  |    | 
|  packets\_out  |  po  |  network\_stats  |  N  |  Number  |  Delta Metric, >= 0  |    | 

**Example**  
The following JSON structure uses long names\.  

```
{
  "header": {
    "report_id": 1530304554,
    "version": "1.0"
  },
  "metrics": {
    "listening_tcp_ports": {
      "ports": [
        {
          "interface": "eth0",
          "port": 24800
        },
        {
          "interface": "eth0",
          "port": 22
        },
        {
          "interface": "eth0",
          "port": 53
        }
      ],
      "total": 3
    },
    "listening_udp_ports": {
      "ports": [
        {
          "interface": "eth0",
          "port": 5353
        },
        {
          "interface": "eth0",
          "port": 67
        }
      ],
      "total": 2
    },
    "network_stats": {
      "bytes_in": 29358693495,
      "bytes_out": 26485035,
      "packets_in": 10013573555,
      "packets_out": 11382615
    },
    "tcp_connections": {
      "established_connections": {
        "connections": [
          {
            "local_interface": "eth0",
            "local_port": 80,
            "remote_addr": "192.168.0.1:8000"
          },
          {
            "local_interface": "eth0",
            "local_port": 80,
            "remote_addr": "192.168.0.1:8000"
          }
        ],
        "total": 2
      }
    }
  },
  "custom_metrics": {
    "MyMetricOfType_Number": [
      {
        "number": 1
      }
    ],
    "MyMetricOfType_NumberList": [
      {
        "number_list": [
          1,
          2,
          3
        ]
      }
    ],
    "MyMetricOfType_StringList": [
      {
        "string_list": [
          "value_1",
          "value_2"
        ]
      }
    ],
    "MyMetricOfType_IpList": [
      {
        "ip_list": [
          "172.0.0.0",
          "172.0.0.10"
        ]
      }
    ]
  }
}
```

**Example JSON structure using short names**  

```
{
  "hed": {
    "rid": 1530305228,
    "v": "1.0"
  },
  "met": {
    "tp": {
      "pts": [
        {
          "if": "eth0",
          "pt": 24800
        },
        {
          "if": "eth0",
          "pt": 22
        },
        {
          "if": "eth0",
          "pt": 53
        }
      ],
      "t": 3
    },
    "up": {
      "pts": [
        {
          "if": "eth0",
          "pt": 5353
        },
        {
          "if": "eth0",
          "pt": 67
        }
      ],
      "t": 2
    },
    "ns": {
      "bi": 29359307173,
      "bo": 26490711,
      "pi": 10014614051,
      "po": 11387620
    },
    "tc": {
      "ec": {
        "cs": [
          {
            "li": "eth0",
            "lp": 80,
            "rad": "192.168.0.1:8000"
          },
          {
            "li": "eth0",
            "lp": 80,
            "rad": "192.168.0.1:8000"
          }
        ],
        "t": 2
      }
    }
  },
  "cmet": {
    "MyMetricOfType_Number": [
      {
        "number": 1
      }
    ],
    "MyMetricOfType_NumberList": [
      {
        "number_list": [
          1,
          2,
          3
        ]
      }
    ],
    "MyMetricOfType_StringList": [
      {
        "string_list": [
          "value_1",
          "value_2"
        ]
      }
    ],
    "MyMetricOfType_IpList": [
      {
        "ip_list": [
          "172.0.0.0",
          "172.0.0.10"
        ]
      }
    ]
  }
}
```

## Sending metrics from devices<a name="DetectMetricsMessages"></a>

AWS IoT Device Defender Detect can collect, aggregate, and monitor metrics data generated by AWS IoT devices to identify devices that exhibit abnormal behavior\. This section shows you how to send metrics from a device to AWS IoT Device Defender\.

You must securely deploy the AWS IoT SDK version two on your AWS IoT connected devices or device gateways to collect device\-side metrics\. See the full list of SDKs [here](https://docs.aws.amazon.com/iot/latest/developerguide/iot-sdks.html)\.

You should use AWS IoT Device Client to publish metrics because it provides a single agent that covers the features present in both AWS IoT Device Defender and AWS IoT Device Management\. These features include jobs, secure tunneling, AWS IoT Device Defender metrics publishing, and more\.

### Using the AWS IoT Device Client to publish metrics<a name="UsingAWSIoTDeviceClient"></a>

To install AWS IoT Device Client, you can download it from [Github](https://github.com/awslabs/aws-iot-device-client)\. After you've installed the AWS IoT Device Client on the device for which you want to collect device\-side data, you must configure it to send device\-side metrics to AWS IoT Device Defender\. Verify that the AWS IoT Device Client [configuration file](https://github.com/awslabs/aws-iot-device-client/blob/main/config-template.json) has the following parameters set in the `device-defender` section:

```
  
  "device-defender":    {
        "enabled":    true,
        "interval-in-seconds": 300
    }
```

**Warning**  
You should set the time interval to a minimum of 300 seconds\. If you set the time interval to anything less than 300 seconds, your metric data may be throttled\.

 After you've updated your configuration, you can create security profiles and behaviors in the AWS IoT Device Defender console to monitor the metrics that your devices publish to the cloud\. You can find published metrics in the AWS IoT Core console by choosing Defend, Detect, and then Metrics\.